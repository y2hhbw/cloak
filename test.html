<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steganography Test</title>
</head>
<body>
    <h1>Steganography Test</h1>
    <input type="file" id="imageInput" accept="image/*">
    <input type="text" id="messageInput" placeholder="Enter message to encode">
    <select id="algorithmSelect">
        <option value="lsb">LSB</option>
        <option value="dct">DCT</option>
        <option value="patchwork">Patchwork</option>
    </select>
    <button id="encodeBtn">Encode</button>
    <button id="decodeBtn">Decode</button>
    <div id="result"></div>
    <img id="testImage" style="display: none;">

    <script src="steganography.js"></script>
    <script>
        document.getElementById('encodeBtn').addEventListener('click', async () => {
            const imageInput = document.getElementById('imageInput');
            const messageInput = document.getElementById('messageInput');
            const algorithmSelect = document.getElementById('algorithmSelect');
            const result = document.getElementById('result');
            const testImage = document.getElementById('testImage');

            if (!imageInput.files || imageInput.files.length === 0) {
                result.textContent = 'Please select an image';
                return;
            }

            if (!messageInput.value) {
                result.textContent = 'Please enter a message';
                return;
            }

            try {
                const file = imageInput.files[0];
                const image = await loadImage(file);
                const encodedDataURL = await Steganography.encode(image, messageInput.value, '', algorithmSelect.value);
                
                // Display the encoded image
                testImage.src = encodedDataURL;
                testImage.style.display = 'block';
                
                // Try to decode the image immediately
                const decodedImage = await loadImage(encodedDataURL);
                const decodedMessage = await Steganography.decode(decodedImage, '', algorithmSelect.value);
                
                result.innerHTML = `
                    <p>Original message: ${messageInput.value}</p>
                    <p>Decoded message: ${decodedMessage}</p>
                    <p>Match: ${messageInput.value === decodedMessage ? 'YES' : 'NO'}</p>
                `;
            } catch (error) {
                result.textContent = 'Error: ' + error.message;
            }
        });

        document.getElementById('decodeBtn').addEventListener('click', async () => {
            const imageInput = document.getElementById('imageInput');
            const algorithmSelect = document.getElementById('algorithmSelect');
            const result = document.getElementById('result');

            if (!imageInput.files || imageInput.files.length === 0) {
                result.textContent = 'Please select an image';
                return;
            }

            try {
                const file = imageInput.files[0];
                const image = await loadImage(file);
                const decodedMessage = await Steganography.decode(image, '', algorithmSelect.value);
                
                result.innerHTML = `<p>Decoded message: ${decodedMessage}</p>`;
            } catch (error) {
                result.textContent = 'Error: ' + error.message;
            }
        });

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const image = new Image();
                    image.onload = () => resolve(image);
                    image.onerror = () => reject(new Error('Image loading failed'));
                    image.src = event.target.result;
                };
                reader.onerror = () => reject(new Error('File reading failed'));
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>